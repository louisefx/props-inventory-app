<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Props Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container-wrapper { padding: 0.5rem; }
        @media (min-width: 640px) { .container-wrapper { padding: 1rem; } }
        @media (min-width: 1024px) { .container-wrapper { padding: 2rem; } }

        /* Main Card Styles */
        .main-content-card {
            width: 100%; margin: 0 auto; background-color: white; padding: 1rem; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        #addPropSection .main-content-card { max-width: 480px; }
        #searchPropsSection .main-content-card { max-width: 1280px; }

        /* UI Elements */
        .btn { padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; border: none; font-size: 0.8rem; line-height: 1.1rem; transition: background-color 0.2s ease-in-out; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .input-field, .select-field { width: 100%; padding: 0.5rem 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; background-color: white; font-size: 0.8rem; color: #1f2937; }
        textarea.input-field { min-height: 80px; }
        label { font-size: 0.75rem; margin-bottom: 0.1rem; color: #4b5563; display: block;}
        .hidden { display: none !important; }

        /* --- ADD PROP PAGE STYLES --- */
        .video-container { position: relative; width: 100%; max-width: 240px; margin: 0 auto; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1); }
        video { display: block; width: 100%; height: auto; }
        .captured-photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.25rem; }
        .captured-photo { position: relative; border: 1px solid #e5e7eb; border-radius: 0.25rem; overflow: hidden; }
        .captured-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .remove-photo-btn { position: absolute; top: 1px; right: 1px; background-color: rgba(239, 68, 68, 0.8); color: white; border-radius: 9999px; width: 18px; height: 18px; font-size: 10px; line-height: 18px; text-align: center; cursor: pointer; border: none; }
        .remove-photo-btn:hover { background-color: #ef4444; }
        .form-row { display: flex; flex-direction: row; gap: 0.5rem; align-items: flex-start; }
        .form-row > div { flex: 1; }
        .form-row > div .input-field, .form-row > div .select-field { margin-bottom: 0; }

        /* --- SEARCH PAGE STYLES --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.6rem 0.8rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; white-space: nowrap; color: #1f2937; }
        th { background-color: #f9fafb; font-weight: 600; color: #111827; }
        td.actions-cell { white-space: nowrap; }
        td .thumbnail-grid { display: flex; flex-wrap: wrap; gap: 0.25rem; max-width: 150px;}
        td .thumbnail-grid img { width: 32px; height: 32px; object-fit: cover; border-radius: 0.125rem; cursor: pointer; transition: transform 0.2s ease-in-out; }
        td .thumbnail-grid img:hover { transform: scale(1.1); }
        .search-bar-container { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .search-bar-container input { flex-grow: 1; margin-bottom: 0; }
        
        /* --- MODAL STYLES (for Edit and Settings) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; color: #1f2937; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn { font-size: 1.5rem; line-height: 1; cursor: pointer; background: none; border: none; color: #4b5563; }

        /* --- IMAGE POPUP (FROM SEARCH) --- */
        #imagePopupOverlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.65); display: flex; align-items: center; justify-content: center; z-index: 1001; padding: 1rem; cursor: pointer; }
        .image-popup-content-wrapper { background-color: white; color: #1f2937; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-width: 95vw; max-height: 95vh; display: flex; flex-direction: column; align-items: center; cursor: default; position: relative; }
        .image-popup-image-area { position: relative; display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 0.75rem; }
        #popupImage { max-width: 100%; max-height: 60vh; object-fit: contain; border-radius: 0.375rem; }
        .popup-arrow { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.3); color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1003; transition: background-color 0.2s; }
        .popup-arrow:hover { background-color: rgba(0, 0, 0, 0.6); }
        .popup-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
        #popupPrevImageButton { left: 0.5rem; }
        #popupNextImageButton { right: 0.5rem; }
        #closeImagePopupButton { position: absolute; top: 0.5rem; right: 0.5rem; background-color: #e5e7eb; color: #374151; border-radius: 9999px; padding: 0.35rem; line-height: 1; z-index: 1002; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="container-wrapper">

    <header class="max-w-md mx-auto mb-4 flex justify-between items-center">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Props App</h1>
        <nav class="flex items-center space-x-2">
            <button id="navInventory" class="btn btn-primary">Inventory</button>
            <button id="navSearch" class="btn btn-secondary">Search</button>
            <button id="navSettings" class="btn btn-secondary p-2" title="Settings">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </button>
        </nav>
    </header>

    <div id="addPropSection">
        <div class="main-content-card">
             <form id="inventoryForm">
                <div class="form-row">
                    <div>
                        <label for="storageIdInput">Storage ID (Box Code):</label>
                        <input type="text" id="storageIdInput" class="input-field" placeholder="e.g., BOX-A1" required>
                    </div>
                    <div>
                        <label for="locationInput">Location:</label>
                        <select id="locationInput" class="select-field" required>
                            <option value="">-- Loading... --</option>
                        </select>
                    </div>
                </div>
            </form>
            <div class="video-container my-4">
                <video id="cameraStreamEl" playsinline autoplay muted class="rounded-lg"></video>
            </div>
            <canvas id="photoCanvasEl" class="hidden"></canvas>
            <div class="text-center">
                <button id="capturePhotoButton" class="btn btn-primary">Capture Photo</button>
            </div>
            <div id="capturedPhotosContainer" class="captured-photos-grid min-h-[70px] bg-gray-100 p-1.5 rounded-md my-4">
                <p class="text-gray-500 text-xs text-center">No photos captured.</p>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-shrink-0">
                    <label for="quantityInput">Quantity:</label>
                    <input type="number" id="quantityInput" class="input-field mb-0" min="1" value="1" required style="width: 70px;">
                </div>
                <div class="flex-grow">
                     <button id="addToInventoryButton" class="btn btn-primary w-full">Add to Inventory</button>
                </div>
            </div>
        </div>
    </div>

    <div id="searchPropsSection" class="hidden">
        <div class="main-content-card">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Manage Props</h1>
            </header>
            <div class="search-bar-container">
                <input type="text" id="searchInput" class="input-field" placeholder="Search props by keyword, ID, location...">
                <button id="searchButton" class="btn btn-primary">Search</button>
                <button id="clearSearchButton" class="btn btn-secondary">Clear</button>
            </div>
            <div class="table-container">
                <table id="propsTable">
                    <thead>
                        <tr>
                            <th>ID</th><th>Storage ID</th><th>Location</th><th>Qty</th><th>Category</th><th>Description</th><th>Keywords</th><th>Status</th><th>Images</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="propsTableBody"></tbody>
                </table>
                <p id="noPropsMessage" class="text-center text-gray-500 py-4 hidden">No props found.</p>
            </div>
        </div>
    </div>

    <div id="editPropModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Prop</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editPropForm">
                     <input type="hidden" id="editPropId">
                    <div class="form-group"><label for="editStorageId">Storage ID (Box Code):</label><input type="text" id="editStorageId" class="input-field" required></div>
                    <div class="form-group"><label for="editLocation">Location:</label><select id="editLocation" class="select-field" required></select></div>
                    <div class="form-group"><label for="editQuantity">Quantity:</label><input type="number" id="editQuantity" class="input-field" min="0" value="1" required></div>
                    <div class="form-group"><label for="editCategory">Category:</label><input type="text" id="editCategory" class="input-field"></div>
                    <div class="form-group"><label for="editDescription">Description:</label><textarea id="editDescription" class="input-field"></textarea></div>
                    <div class="form-group"><label for="editKeywords">Keywords (comma-separated):</label><input type="text" id="editKeywords" class="input-field"></div>
                    <div class="form-group"><label for="editStatus">Status:</label><select id="editStatus" class="select-field"><option value="Available">Available</option><option value="In Use">In Use</option><option value="Needs Repair">Needs Repair</option><option value="Archived">Archived</option></select></div>
                    <div class="form-group"><label>Current Images:</label><div id="editPropImages" class="thumbnail-grid border p-2 rounded-md bg-gray-50 min-h-[40px]"></div></div>
                </form>
            </div>
            <div class="modal-footer text-right mt-4"><button id="saveChangesButton" class="btn btn-primary">Save Changes</button><button class="btn btn-secondary ml-2 modal-close-btn">Cancel</button></div>
        </div>
    </div>
    
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Locations</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <section class="mb-6">
                    <h3 class="font-semibold text-lg mb-2">Add New Location</h3>
                    <form id="addLocationForm" class="flex items-center gap-2">
                        <input type="text" id="newLocationNameInput" class="input-field mb-0 flex-grow" placeholder="e.g., Shelf C3" required>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </section>
                <section>
                    <h3 class="font-semibold text-lg mb-2">Current Locations</h3>
                    <div id="currentLocationsList" class="bg-gray-100 p-3 rounded-md min-h-[100px] max-h-48 overflow-y-auto">
                        </div>
                </section>
            </div>
        </div>
    </div>

    <div id="imagePopupOverlay" class="hidden">
        <div class="image-popup-content-wrapper">
            <button id="closeImagePopupButton" title="Close image preview"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div class="image-popup-image-area">
                <button id="popupPrevImageButton" class="popup-arrow hidden" title="Previous image">&lt;</button>
                <img id="popupImage" src="" alt="Enlarged prop image">
                <button id="popupNextImageButton" class="popup-arrow hidden" title="Next image">&gt;</button>
            </div>
            <div id="popupImageInfo" class="image-popup-info text-left w-full max-h-20vh overflow-y-auto pt-2"><h4 id="popupInfoStorageId" class="text-lg font-bold"></h4><p><strong>Description:</strong> <span id="popupInfoDescription"></span></p><p><strong>Location:</strong> <span id="popupInfoLocation"></span></p><p><strong>Category:</strong> <span id="popupInfoCategory"></span></p><p><strong>Keywords:</strong> <span id="popupInfoKeywords"></span></p><p><strong>Status:</strong> <span id="popupInfoStatus"></span></p><p><strong>Quantity:</strong> <span id="popupInfoQuantity"></span></p></div>
        </div>
    </div>

    <div id="messageArea" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // --- CONFIG & GLOBAL VARS ---
        const API_BASE_URL = ''; // Use relative paths
        let activeStream = null;
        let capturedPhotoDataUrls = [];
        let allLocations = [];

        // --- DOM ELEMENT SELECTORS ---
        // Navigation
        const navInventory = document.getElementById('navInventory');
        const navSearch = document.getElementById('navSearch');
        const navSettings = document.getElementById('navSettings');
        const addPropSection = document.getElementById('addPropSection');
        const searchPropsSection = document.getElementById('searchPropsSection');

        // Add Prop Elements
        const cameraStreamEl = document.getElementById('cameraStreamEl');
        const photoCanvasEl = document.getElementById('photoCanvasEl');
        const capturePhotoButton = document.getElementById('capturePhotoButton');
        const capturedPhotosContainer = document.getElementById('capturedPhotosContainer');
        const storageIdInput = document.getElementById('storageIdInput');
        const locationInput = document.getElementById('locationInput');
        const quantityInput = document.getElementById('quantityInput');
        const addToInventoryButton = document.getElementById('addToInventoryButton');

        // Search Prop Elements
        const propsTableBody = document.getElementById('propsTableBody');
        const noPropsMessage = document.getElementById('noPropsMessage');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const messageArea = document.getElementById('messageArea');

        // Edit Modal Elements
        const editPropModal = document.getElementById('editPropModal');
        const saveChangesButton = document.getElementById('saveChangesButton');
        const editPropIdInput = document.getElementById('editPropId');
        const editStorageIdInput = document.getElementById('editStorageId');
        const editLocationInput = document.getElementById('editLocation');
        const editQuantityInput = document.getElementById('editQuantity');
        const editCategoryInput = document.getElementById('editCategory');
        const editDescriptionInput = document.getElementById('editDescription');
        const editKeywordsInput = document.getElementById('editKeywords');
        const editStatusInput = document.getElementById('editStatus');
        const editPropImagesContainer = document.getElementById('editPropImages');
        
        // Settings Modal Elements
        const settingsModal = document.getElementById('settingsModal');
        const addLocationForm = document.getElementById('addLocationForm');
        const newLocationNameInput = document.getElementById('newLocationNameInput');
        const currentLocationsList = document.getElementById('currentLocationsList');

        // Image Popup Elements
        const imagePopupOverlay = document.getElementById('imagePopupOverlay');
        const popupImage = document.getElementById('popupImage');
        // ... (rest of the image popup selectors are the same)

        // --- NAVIGATION LOGIC ---
        function showSection(sectionId) {
            addPropSection.classList.add('hidden');
            searchPropsSection.classList.add('hidden');
            navInventory.classList.replace('btn-primary', 'btn-secondary');
            navSearch.classList.replace('btn-primary', 'btn-secondary');

            if (sectionId === 'add') {
                addPropSection.classList.remove('hidden');
                navInventory.classList.replace('btn-secondary', 'btn-primary');
                startCamera();
            } else { // search
                searchPropsSection.classList.remove('hidden');
                navSearch.classList.replace('btn-secondary', 'btn-primary');
                stopCamera();
                fetchProps(); 
            }
        }
        navInventory.addEventListener('click', () => showSection('add'));
        navSearch.addEventListener('click', () => showSection('search'));

        // --- UI MESSAGE ---
        function showUIMessage(message, type = 'success', duration = 3000) {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = message;
            msgDiv.className = `p-3 rounded-md shadow-lg mb-2 text-sm ${type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            messageArea.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), duration);
        }

        // --- ADD PROP LOGIC ---
        async function startCamera() {
            if (activeStream) return;
            try {
                activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraStreamEl.srcObject = activeStream;
            } catch (err) {
                showUIMessage('Could not access camera. Please check permissions.', 'error', false);
            }
        }
        function stopCamera() {
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
                activeStream = null;
                cameraStreamEl.srcObject = null;
            }
        }
        capturePhotoButton.addEventListener('click', () => {
            if (!activeStream) { showUIMessage('Camera not active.', 'error'); return; }
            const context = photoCanvasEl.getContext('2d');
            photoCanvasEl.width = cameraStreamEl.videoWidth;
            photoCanvasEl.height = cameraStreamEl.videoHeight;
            context.drawImage(cameraStreamEl, 0, 0, photoCanvasEl.width, photoCanvasEl.height);
            capturedPhotoDataUrls.push({ id: Date.now(), url: photoCanvasEl.toDataURL('image/jpeg', 0.9) });
            renderCapturedPhotos();
        });
        function renderCapturedPhotos() {
            capturedPhotosContainer.innerHTML = '';
            if (capturedPhotoDataUrls.length === 0) {
                capturedPhotosContainer.innerHTML = '<p class="text-gray-500 text-xs text-center">No photos captured.</p>';
            } else {
                capturedPhotoDataUrls.forEach((photo) => {
                    const pDiv = document.createElement('div'); pDiv.className = 'captured-photo';
                    const img = document.createElement('img'); img.src = photo.url;
                    const rmBtn = document.createElement('button'); rmBtn.className = 'remove-photo-btn'; rmBtn.innerHTML = '&times;';
                    rmBtn.onclick = () => {
                        capturedPhotoDataUrls = capturedPhotoDataUrls.filter(p => p.id !== photo.id);
                        renderCapturedPhotos();
                    };
                    pDiv.append(img, rmBtn); capturedPhotosContainer.appendChild(pDiv);
                });
            }
        }
        addToInventoryButton.addEventListener('click', async () => {
            const storageId = storageIdInput.value.trim();
            const location = locationInput.value;
            const quantity = parseInt(quantityInput.value);
            if (!storageId || !location || !quantity || capturedPhotoDataUrls.length === 0) {
                showUIMessage('Please fill all fields and add at least one photo.', 'error');
                return;
            }
            addToInventoryButton.disabled = true; addToInventoryButton.textContent = 'Adding...';
            try {
                const response = await fetch(`${API_BASE_URL}/api/add_prop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        storageId: storageId,
                        location: location,
                        quantity: quantity,
                        photos: capturedPhotoDataUrls.map(p => p.url),
                        timestamp: new Date().toISOString()
                    })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                showUIMessage('Prop added successfully!', 'success');
                
                // NEW: Save the successful Storage ID to session storage
                sessionStorage.setItem('lastStorageId', storageId);
                
                // CHANGED: Only clear the fields that need resetting
                locationInput.selectedIndex = 0;
                quantityInput.value = '1';
                capturedPhotoDataUrls = [];
                renderCapturedPhotos();

            } catch (error) {
                showUIMessage(`Error adding prop: ${error.message}`, 'error');
            } finally {
                addToInventoryButton.disabled = false; addToInventoryButton.textContent = 'Add to Inventory';
            }
        });

        // --- LOCATION MANAGEMENT ---
        async function fetchAndPopulateLocations() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations`);
                if (!response.ok) throw new Error('Failed to fetch locations');
                allLocations = await response.json();
                
                const selectedLocation = locationInput.value;
                locationInput.innerHTML = '<option value="">-- Select Location --</option>';
                allLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.name;
                    option.textContent = loc.name;
                    locationInput.appendChild(option);
                });
                locationInput.value = selectedLocation;

                const selectedEditLocation = editLocationInput.value;
                editLocationInput.innerHTML = '<option value="">-- Select Location --</option>';
                 allLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.name;
                    option.textContent = loc.name;
                    editLocationInput.appendChild(option);
                });
                editLocationInput.value = selectedEditLocation;

                currentLocationsList.innerHTML = '';
                if (allLocations.length === 0) {
                    currentLocationsList.innerHTML = '<p class="text-gray-500 text-sm">No locations defined yet.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside text-gray-700 space-y-1';
                    allLocations.forEach(loc => {
                        const li = document.createElement('li');
                        li.textContent = loc.name;
                        ul.appendChild(li);
                    });
                    currentLocationsList.appendChild(ul);
                }
            } catch (error) {
                showUIMessage(`Could not load locations: ${error.message}`, "error", false);
            }
        }
        
        addLocationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const locationName = newLocationNameInput.value.trim();
            if (!locationName) {
                showUIMessage('Location name cannot be empty.', 'error');
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: locationName })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                showUIMessage(`Location "${locationName}" added.`, 'success');
                newLocationNameInput.value = '';
                await fetchAndPopulateLocations();
            } catch (error) {
                showUIMessage(`Error: ${error.message}`, 'error');
            }
        });

        // --- All other functions (Search, Modals, Popups) remain the same ---
        // ... (The rest of your JavaScript code is unchanged) ...
        async function fetchProps(searchTerm = '') {
            propsTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4">Loading...</td></tr>`;
            try {
                const url = searchTerm ? `${API_BASE_URL}/api/props?search=${encodeURIComponent(searchTerm)}` : `${API_BASE_URL}/api/props`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const props = await response.json();
                renderProps(props);
            } catch (error) {
                propsTableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading props: ${error.message}</td></tr>`;
            }
        }
        function renderProps(props) {
            propsTableBody.innerHTML = '';
            noPropsMessage.classList.toggle('hidden', props.length > 0);
            props.forEach(prop => {
                const row = propsTableBody.insertRow();
                row.insertCell().textContent = prop.id;
                row.insertCell().textContent = prop.Storage_id;
                row.insertCell().textContent = prop.Location;
                row.insertCell().textContent = prop.Quantity;
                row.insertCell().textContent = prop.Category || 'N/A';
                row.insertCell().textContent = prop.Description ? (prop.Description.length > 30 ? prop.Description.substring(0, 30) + '...' : prop.Description) : 'N/A';
                row.insertCell().textContent = prop.Keywords ? (prop.Keywords.length > 20 ? prop.Keywords.substring(0, 20) + '...' : prop.Keywords) : 'N/A';
                row.insertCell().textContent = prop.Status;
                
                const imagesCell = row.insertCell();
                const imgGrid = document.createElement('div');
                imgGrid.className = 'thumbnail-grid';
                if (prop.file && prop.file.length > 0) {
                    prop.file.slice(0, 3).forEach(filename => {
                        const img = document.createElement('img');
                        const imgSrc = `${API_BASE_URL}/uploads/${filename}`;
                        img.src = imgSrc;
                        img.addEventListener('click', () => showImagePopup(imgSrc, prop));
                        imgGrid.appendChild(img);
                    });
                } else { imgGrid.textContent = 'None'; }
                imagesCell.appendChild(imgGrid);

                const actionsCell = row.insertCell();
                actionsCell.className = 'actions-cell';
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.42a4 4 0 0 0-.885 1.343Z" /></svg>`;
                editButton.className = 'btn btn-warning p-1 mr-1';
                editButton.onclick = () => openEditModal(prop.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" /></svg>`;
                deleteButton.className = 'btn btn-danger p-1';
                deleteButton.onclick = () => deleteProp(prop.id, prop.Storage_id);
                actionsCell.appendChild(deleteButton);
            });
        }
        searchButton.addEventListener('click', () => fetchProps(searchInput.value));
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchProps(searchInput.value); });
        clearSearchButton.addEventListener('click', () => { searchInput.value = ''; fetchProps(); });
        function setupModal(modal, openButtons, closeButtons) {
            openButtons.forEach(btn => btn.addEventListener('click', () => modal.classList.remove('hidden')));
            closeButtons.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
        }
        async function openEditModal(propId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/prop/${propId}`);
                if (!response.ok) throw new Error('Failed to fetch prop details');
                const prop = await response.json();
                editPropIdInput.value = prop.id;
                editStorageIdInput.value = prop.Storage_id;
                editLocationInput.value = prop.Location;
                editQuantityInput.value = prop.Quantity;
                editCategoryInput.value = prop.Category || '';
                editDescriptionInput.value = prop.Description || '';
                editKeywordsInput.value = prop.Keywords || '';
                editStatusInput.value = prop.Status;
                editPropModal.classList.remove('hidden');
            } catch (error) {
                showUIMessage(`Error: ${error.message}`, "error");
            }
        }
        setupModal(editPropModal, [], document.querySelectorAll('#editPropModal .modal-close-btn'));
        setupModal(settingsModal, [navSettings], document.querySelectorAll('#settingsModal .modal-close-btn'));
        saveChangesButton.addEventListener('click', async () => {
             const propId = editPropIdInput.value;
            const updatedData = {
                Storage_id: editStorageIdInput.value, Location: editLocationInput.value, Quantity: parseInt(editQuantityInput.value),
                Category: editCategoryInput.value, Description: editDescriptionInput.value, Keywords: editKeywordsInput.value, Status: editStatusInput.value
            };
            try {
                const response = await fetch(`${API_BASE_URL}/api/prop/${propId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showUIMessage("Prop updated successfully!", "success");
                editPropModal.classList.add('hidden');
                fetchProps(searchInput.value);
            } catch (error) { showUIMessage(`Error: ${error.message}`, "error"); }
        });
        async function deleteProp(propId, storageId) {
            if (!confirm(`Delete prop "${storageId}"?`)) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/prop/${propId}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showUIMessage('Prop deleted successfully!', 'success');
                fetchProps(searchInput.value);
            } catch (error) { showUIMessage(`Error: ${error.message}`, "error"); }
        }
        function showImagePopup(clickedImageSrc, prop) {
            currentPopupPropDetails = prop;
            currentPopupImages = prop.file.map(filename => `${API_BASE_URL}/uploads/${filename}`);
            currentPopupImageIndex = currentPopupImages.indexOf(clickedImageSrc);
            if (currentPopupImageIndex === -1) currentPopupImageIndex = 0;
            updatePopupImageAndInfo();
            imagePopupOverlay.classList.remove('hidden');
            updatePopupArrows();
        }
        function hideImagePopup() { imagePopupOverlay.classList.add('hidden'); }
        function updatePopupImageAndInfo() {
            if (!currentPopupPropDetails) return;
            popupImage.src = currentPopupImages[currentPopupImageIndex];
            popupInfoStorageId.textContent = currentPopupPropDetails.Storage_id;
            popupInfoDescription.textContent = currentPopupPropDetails.Description;
            popupInfoLocation.textContent = currentPopupPropDetails.Location;
            popupInfoCategory.textContent = currentPopupPropDetails.Category;
            popupInfoKeywords.textContent = currentPopupPropDetails.Keywords;
            popupInfoStatus.textContent = currentPopupPropDetails.Status;
            popupInfoQuantity.textContent = currentPopupPropDetails.Quantity;
        }
        function updatePopupArrows() {
            const show = currentPopupImages.length > 1;
            popupPrevImageButton.classList.toggle('hidden', !show);
            popupNextImageButton.classList.toggle('hidden', !show);
            if(show){
                popupPrevImageButton.disabled = currentPopupImageIndex === 0;
                popupNextImageButton.disabled = currentPopupImageIndex === currentPopupImages.length - 1;
            }
        }
        popupPrevImageButton.addEventListener('click', (e) => { e.stopPropagation(); if (currentPopupImageIndex > 0) { currentPopupImageIndex--; updatePopupImageAndInfo(); updatePopupArrows(); } });
        popupNextImageButton.addEventListener('click', (e) => { e.stopPropagation(); if (currentPopupImageIndex < currentPopupImages.length - 1) { currentPopupImageIndex++; updatePopupImageAndInfo(); updatePopupArrows(); } });
        closeImagePopupButton.addEventListener('click', hideImagePopup);
        imagePopupOverlay.addEventListener('click', (e) => { if(e.target === imagePopupOverlay) hideImagePopup()});
        
        // --- INITIAL LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            // NEW: Load the last saved Storage ID from session storage
            const savedStorageId = sessionStorage.getItem('lastStorageId');
            if (savedStorageId) {
                storageIdInput.value = savedStorageId;
            }

            // Existing code
            showSection('add');
            fetchAndPopulateLocations();
            renderCapturedPhotos();
        });
    </script>
</body>
</html>
