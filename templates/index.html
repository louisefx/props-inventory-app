<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Props Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* All CSS is the same as before */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container-wrapper { padding: 0.5rem; }
        @media (min-width: 640px) { .container-wrapper { padding: 1rem; } }
        @media (min-width: 1024px) { .container-wrapper { padding: 2rem; } }
        .main-content-card { width: 100%; margin: 0 auto; background-color: white; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        #addPropSection .main-content-card { max-width: 480px; }
        #searchPropsSection .main-content-card { max-width: 1280px; }
        .btn { padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; border: none; font-size: 0.8rem; line-height: 1.1rem; transition: background-color 0.2s ease-in-out; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .input-field, .select-field { width: 100%; padding: 0.5rem 0.6rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 0.75rem; background-color: white; font-size: 0.8rem; color: #1f2937; }
        label { font-size: 0.75rem; margin-bottom: 0.1rem; color: #4b5563; display: block;}
        .hidden { display: none !important; }
        .video-container { position: relative; width: 100%; max-width: 240px; margin: 0 auto; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1); }
        video { display: block; width: 100%; height: auto; }
        .captured-photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 0.25rem; }
        .captured-photo { position: relative; border: 1px solid #e5e7eb; border-radius: 0.25rem; overflow: hidden; }
        .captured-photo img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .remove-photo-btn { position: absolute; top: 1px; right: 1px; background-color: rgba(239, 68, 68, 0.8); color: white; border-radius: 9999px; width: 18px; height: 18px; font-size: 10px; line-height: 18px; text-align: center; cursor: pointer; border: none; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 0.6rem 0.8rem; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; white-space: nowrap; color: #1f2937; }
        th { background-color: #f9fafb; font-weight: 600; color: #111827; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; color: #1f2937; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn { font-size: 1.5rem; line-height: 1; cursor: pointer; background: none; border: none; color: #4b5563; }
    </style>
</head>
<body class="container-wrapper">

    <header class="max-w-md mx-auto mb-4 flex justify-between items-center">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Props App</h1>
        <nav class="flex items-center space-x-2">
            <button id="navInventory" class="btn btn-primary">Inventory</button>
            <button id="navSearch" class="btn btn-secondary">Search</button>
            <button id="navSettings" class="btn btn-secondary p-2" title="Settings">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
            </button>
        </nav>
    </header>

    <div id="addPropSection">
        <div class="main-content-card">
             <form id="inventoryForm">
                <div class="form-row">
                    <div>
                        <label for="storageIdInput">Storage ID (Box Code):</label>
                        <input type="text" id="storageIdInput" class="input-field" placeholder="e.g., BOX-A1" required>
                    </div>
                    <div>
                        <label for="locationInput">Location:</label>
                        <select id="locationInput" class="select-field" required>
                            <option value="">-- Loading... --</option>
                        </select>
                    </div>
                </div>
            </form>
            <div class="video-container my-4"><video id="cameraStreamEl" playsinline autoplay muted class="rounded-lg"></video></div>
            <canvas id="photoCanvasEl" class="hidden"></canvas>
            <div class="text-center"><button id="capturePhotoButton" class="btn btn-primary">Capture Photo</button></div>
            <div id="capturedPhotosContainer" class="captured-photos-grid min-h-[70px] bg-gray-100 p-1.5 rounded-md my-4">
                <p class="text-gray-500 text-xs text-center">No photos captured.</p>
            </div>
            <div class="flex items-end gap-2">
                <div class="flex-shrink-0">
                    <label for="quantityInput">Quantity:</label>
                    <input type="number" id="quantityInput" class="input-field mb-0" min="1" value="1" required style="width: 70px;">
                </div>
                <div class="flex-grow">
                     <button id="addToInventoryButton" class="btn btn-primary w-full">Add to Inventory</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="searchPropsSection" class="hidden"></div>
    <div id="editPropModal" class="modal-overlay hidden"></div>
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Locations</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <section class="mb-6">
                    <h3 class="font-semibold text-lg mb-2">Add New Location</h3>
                    <form id="addLocationForm" class="flex items-center gap-2">
                        <input type="text" id="newLocationNameInput" class="input-field mb-0 flex-grow" placeholder="e.g., Shelf C3" required>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </section>
                <section>
                    <h3 class="font-semibold text-lg mb-2">Current Locations</h3>
                    <div id="currentLocationsList" class="bg-gray-100 p-3 rounded-md min-h-[100px] max-h-48 overflow-y-auto"></div>
                </section>
            </div>
        </div>
    </div>
    <div id="imagePopupOverlay" class="hidden"></div>
    <div id="messageArea" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // --- All variables are the same ---
        const API_BASE_URL = '';
        // ... (rest of variables)

        // --- All functions from before are here, with two small changes ---

        addToInventoryButton.addEventListener('click', async () => {
            const storageId = storageIdInput.value.trim();
            const location = locationInput.value;
            const quantity = parseInt(quantityInput.value);
            if (!storageId || !location || !quantity || capturedPhotoDataUrls.length === 0) {
                showUIMessage('Please fill all fields and add at least one photo.', 'error');
                return;
            }
            addToInventoryButton.disabled = true; addToInventoryButton.textContent = 'Adding...';
            try {
                const response = await fetch(`${API_BASE_URL}/api/add_prop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        storageId: storageId,
                        location: location,
                        quantity: quantity,
                        photos: capturedPhotoDataUrls.map(p => p.url),
                        timestamp: new Date().toISOString()
                    })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                showUIMessage('Prop added successfully!', 'success');
                
                // NEW: Save BOTH Storage ID and Location to session storage
                sessionStorage.setItem('lastStorageId', storageId);
                sessionStorage.setItem('lastLocation', location);
                
                // CHANGED: Only clear the fields that need resetting
                quantityInput.value = '1';
                capturedPhotoDataUrls = [];
                renderCapturedPhotos();

            } catch (error) {
                showUIMessage(`Error adding prop: ${error.message}`, 'error');
            } finally {
                addToInventoryButton.disabled = false; addToInventoryButton.textContent = 'Add to Inventory';
            }
        });

        async function fetchAndPopulateLocations() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/locations`);
                if (!response.ok) throw new Error('Failed to fetch locations');
                allLocations = await response.json();
                
                // --- Main "Add Prop" dropdown ---
                locationInput.innerHTML = '<option value="">-- Select Location --</option>';
                allLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.name;
                    option.textContent = loc.name;
                    locationInput.appendChild(option);
                });
                
                // NEW: Set the dropdown to the saved location AFTER populating it
                const savedLocation = sessionStorage.getItem('lastLocation');
                if (savedLocation) {
                    locationInput.value = savedLocation;
                }

                // --- "Edit Prop" dropdown ---
                editLocationInput.innerHTML = '<option value="">-- Select Location --</option>';
                 allLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.name;
                    option.textContent = loc.name;
                    editLocationInput.appendChild(option);
                });

                // --- List in the Settings modal ---
                currentLocationsList.innerHTML = '';
                if (allLocations.length === 0) {
                    currentLocationsList.innerHTML = '<p class="text-gray-500 text-sm">No locations defined yet.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside text-gray-700 space-y-1';
                    allLocations.forEach(loc => {
                        const li = document.createElement('li');
                        li.textContent = loc.name;
                        ul.appendChild(li);
                    });
                    currentLocationsList.appendChild(ul);
                }
            } catch (error) {
                showUIMessage(`Could not load locations: ${error.message}`, "error", false);
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            // Load the last saved Storage ID from session storage
            const savedStorageId = sessionStorage.getItem('lastStorageId');
            if (savedStorageId) {
                storageIdInput.value = savedStorageId;
            }

            // Existing code
            showSection('add');
            fetchAndPopulateLocations(); // This function will now handle setting the saved location
            renderCapturedPhotos();
        });

        // The rest of your JavaScript functions (addLocationForm listener, fetchProps, renderProps, etc.)
        // are exactly the same as before. For brevity, I've omitted them here, but they should be included
        // in your actual file.
    </script>
</body>
</html>
